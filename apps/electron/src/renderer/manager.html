<!doctype html>
<html lang="en" data-bs-theme="dark">

<script src="./ui/bootstrap.js"></script>
<link href="./ui/halfmoon.css" rel="stylesheet">

<div class="container mt-3 w-50">
	<div class="mb-3">
		<label class="form-label">username</label>
		<input type="text" class="form-control" id="username">
	</div>
	<div class="mb-3">
		<label class="form-label">password</label>
		<input type="text" class="form-control" id="password">
	</div>
	<button type="submit" class="btn btn-primary" id="submit">add account</button>
</div>

<div class="container border-top mt-4"></div>
<div id="accounts" class="container flex flex-row justify-content-between"></div>

<script>
	const electron = require("electron");
	const path = require("path");
	const fs = require("fs");
	const { promisify } = require("util");

	const stat = promisify(fs.stat);
	const read = promisify(fs.readFile);
	const write = promisify(fs.writeFile);

	const dir = path.join(electron.remote.app.getPath("documents"), "Vexed");
	const json_path = path.join(dir, "accounts.json");

	const { createGameWindow } = electron.remote.require("../main/util/createWindow");

	async function getServers() {
		const servers = await fetch("https://game.aq.com/game/api/data/servers")
			.then((res) => res.json())
			.catch(() => null);

		if (!servers) {
			return;
		}

		const div = document.createElement("div");
		div.classList.add("container", "mt-4");

		const p = document.createElement("p");
		p.textContent = "server: "
		div.appendChild(p);

		const button = document.createElement("button");
		button.classList.add("btn", "btn-primary", "dropdown-toggle");
		button.id = "server";
		button.textContent = "None";
		button.setAttribute("type", "button");
		button.setAttribute("data-bs-toggle", "dropdown");
		button.setAttribute("aria-expanded", "false");
		div.appendChild(button);

		const ul = document.createElement("ul");
		ul.classList.add("dropdown-menu");

		const li = document.createElement("li");
		const a = document.createElement("a");
		a.textContent = "None";
		a.classList.add("dropdown-item");
		a.addEventListener("click", () => button.textContent = "None");
		li.appendChild(a);
		ul.appendChild(li);

		for (const server of servers) {
			const li = document.createElement("li");
			const a = document.createElement("a");
			a.textContent = `${server.sName} (${server.iCount})`;
			a.classList.add("dropdown-item");
			a.addEventListener("click", () => button.textContent = server.sName);
			li.appendChild(a);
			ul.appendChild(li);
		}

		div.appendChild(ul);
		document.body.appendChild(div);
	}

	async function render() {
		const accounts = JSON.parse(await read(json_path, "utf8"));
		const div = document.getElementById("accounts");
		div.innerHTML = '';

		const ul = document.createElement("ul");
		ul.classList.add("mt-4");

		for (const account of accounts) {
			const li = document.createElement("li");
			li.classList.add("mb-4");

			const p = document.createElement("p");
			p.textContent = account.username;
			li.appendChild(p);

			const div = document.createElement("div");

			{
				const button = document.createElement("button");
				button.classList = "btn btn-primary";
				button.textContent = "sign in";
				button.addEventListener("click", async (event) => {
					await createGameWindow(
						Object.assign({
							server: document.getElementById("server").textContent
						}, account)
					);
				});
				div.appendChild(button);
			}

			{
				const button = document.createElement("button");
				button.classList = "btn btn-danger";
				button.textContent = "remove";
				button.addEventListener("click", async (event) => {
					const idx = accounts.findIndex(a => a.username === account.username && a.password === account.password);
					accounts.splice(idx, 1);

					await write(json_path, JSON.stringify(accounts), "utf8");
					await render();
				});
				div.appendChild(button);
			}

			li.appendChild(div);
			ul.appendChild(li);
		}
		div.appendChild(ul);

		document.body.appendChild(div);
	}

	(async () => {
		await getServers();
		await render();
	})();
	document.getElementById("submit")?.addEventListener("click", async function () {
		const username = document.getElementById("username")?.value;
		const password = document.getElementById("password")?.value;

		const stats = await stat(json_path).catch(() => null);

		if (!stats?.isFile()) {
			await write(json_path, JSON.stringify([]));
		}

		const accounts = await read(json_path, "utf8");
		const _accounts = JSON.parse(accounts);

		_accounts.push({ username, password });
		await write(json_path, JSON.stringify(_accounts), "utf8");
		await render();
	});
</script>

</html>