<style>
	html,
	body {
		height: 100%;
		width: 100%;
		margin: 0;
	}

	#game {
		position: relative;
	}

	#swf {
		position: fixed;
		bottom: 0;
		right: 0;
		width: 100%;
		height: 98%;
	}

	#nav {
		width: 100%;
		z-index: -1;
		color: white;
	}

	#progress-container {
		position: fixed;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		background-color: black;
		display: flex;
		justify-content: center;
		align-items: center;
	}

	#progress {
		width: 75%;
	}

	.navbar .container-fluid {
		padding-left: 0;
		padding-right: 0;
		margin-left: 0;
		margin-right: 0;
	}

	.navbar-nav .nav-link {
		font-size: 16px;
	}

	.navbar {
		height: 27px !important;
		padding: -4px;
	}

	.nav-item .nav-link {
		color: white;
	}

	.nav-item:focus .nav-link:focus {
		color: white;
	}
</style>

<link href="./ui/halfmoon.css" rel="stylesheet">
<script src="./ui/bootstrap.js"></script>
<script>
	// https://github.com/electron/electron/issues/254
	window.$ = window.jQuery = require("./ui/jquery.js");
</script>

<script src="jsapi/ItemBase.js"></script>
<script src="jsapi/Faction.js"></script>
<script src="jsapi/Quest.js"></script>
<script src="jsapi/Avatar.js"></script>
<script src="jsapi/Monster.js"></script>

<script src="jsapi/Auth.js"></script>
<script src="jsapi/Bank.js"></script>
<script src="jsapi/Bot.js"></script>
<script src="jsapi/Combat.js"></script>
<script src="jsapi/Drops.js"></script>
<script src="jsapi/Flash.js"></script>
<script src="jsapi/House.js"></script>
<script src="jsapi/Inventory.js"></script>
<script src="jsapi/Packet.js"></script>
<script src="jsapi/Player.js"></script>
<script src="jsapi/Quests.js"></script>
<script src="jsapi/Server.js"></script>
<script src="jsapi/Settings.js"></script>
<script src="jsapi/Shops.js"></script>
<script src="jsapi/TempInventory.js"></script>
<script src="jsapi/World.js"></script>

<script src="ipc/flash-ipc.js"></script>
<script src="ipc/ipc.js"></script>

<script>
	window.addEventListener('DOMContentLoaded', () => {
		var script = document.createElement('script');
		script.textContent = `
			var bot=Bot.getInstance();
			var auth=bot.auth;
			var bank=bot.bank;
			var combat=bot.combat;
			var drops=bot.drops;
			var flash=bot.flash;
			var house=bot.house;
			var inventory=bot.inventory;
			var packets=bot.packets;
			var player=bot.player;
			var quests=bot.quests;
			var settings=bot.settings;
			var shops=bot.shops;
			var tempInventory=bot.tempInventory;
			var world=bot.world;
		`;
		document.body.appendChild(script);
	});
</script>

<script>

	var { ipcRenderer } = require('electron');
	window.addEventListener('keydown', (event) => {
		switch (event.key) {
			// Allow the game to be closed whilst the game is focused
			case 'q': {
				if (event.metaKey) {
					// ipcRenderer.invoke("gameQuit");
				}
				break;
			}
			case 'PageUp':
				ipcRenderer.invoke("loadScript");
				break;
		}
	});
	window.addEventListener('DOMContentLoaded', () => {
		var div = document.createElement('div');
		div.id = 'progress-container';
		document.body.appendChild(div);

		var progress = document.createElement('progress');
		progress.id = 'progress';
		progress.max = "100";
		progress.value = "0";
		document.getElementById('progress-container').appendChild(progress);
	});

	async function progress([percentage]) {
		var progress = document.getElementById('progress');
		progress.value = percentage.toString();

		if (percentage === 100) {
			var progressContainer = document.getElementById('progress-container');
			progress?.remove();
			progressContainer?.remove();

			// document.querySelector(".nav").style.zIndex = '1000';

			if (window?.account) {
				const { username, password, server } = window.account;
				const bot = Bot.getInstance();
				await bot.sleep(1000);
				await auth.login(username, password);
				if (server !== "None") {
					await bot.waitUntil(() => auth?.servers?.length > 0);
					await bot.sleep(250);
					await auth.connect(server);
					await bot.sleep(1000);
				}
				delete window.account;
			}
		}
	}

	$(document).ready(function () {
		window.lastMap = null;

		function updateCells() {
			const bot = Bot.getInstance();
			const { auth, player, world } = bot;

			if (!auth.loggedIn || world.loading || window.lastMap === bot.world.roomId) {
				return;
			}

			const elem = $("#cells");
			elem.empty();

			const { cells } = world;
			$.each(cells, function (_, option) {
				elem.append($('<option>', {
					value: option,
					text: option,
				}));
			});

			window.lastMap = world.roomId;
		}

		$("#pads").on("change", async function () {
			const { auth, world } = Bot.getInstance();
			if (!auth.loggedIn || world.loading) {
				return;
			}

			const cell = $("#cells").val() ?? player.cell;
			const pad = $(this).val();

			await Bot.getInstance().world.jump(cell, pad);
		});

		$("#cells").on("click", updateCells)
			.on("change", async function () {
				const { auth, world } = Bot.getInstance();
				if (!auth.loggedIn || world.loading) {
					return;
				}

				const cell = $(this).val();
				const pad = $("#pads").val() ?? "Spawn";

				await Bot.getInstance().world.jump(cell, pad);
			});

		$("#bank").on("click", function () {
			Bot.getInstance().flash.call("world.toggleBank");
		});
	});
</script>

<div id="game">
	<embed id="swf" src="grimoire.swf" type="application/x-shockwave-flash"></embed>
</div>

<div id="nav">
	<nav class="navbar fixed-top" style="background-color: #24242e;">
		<div class="container-fluid d-flex justify-content-between mx-3">
			<div class="d-flex align-items-center">
				<ul class="navbar-nav d-flex flex-row gap-2" style="margin-top: -13px; margin-left: -8px;">
					<li class="nav-item">
						<a class="nav-link" href="#">Bot</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" href="#">Tools</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" href="#">Packets</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" href="#">Options</a>
					</li>
					<!-- <li class="nav-item">
						<a class="nav-link" href="#">Maid</a>
					</li> -->
				</ul>
			</div>
			<div class="d-flex align-items-center gap-2" style="margin-top: -12px;">
				<div class="nav-item">
					<select class="form-select form-select-sm" id="pads">
						<option value="" selected disabled hidden></option>
						<option value="Center">Center</option>
						<option value="Spawn">Spawn</option>
						<option value="Left">Left</option>
						<option value="Right">Right</option>
						<option value="Top">Top</option>
						<option value="Bottom">Bottom</option>
						<option value="Up">Up</option>
						<option value="Down">Down</option>
					</select>
				</div>
				<div class="nav-item">
					<select class="form-select form-select-sm" id="cells"></select>
				</div>
				<div class="nav-item">
					<button class="btn btn-sm btn-outline-secondary" id="bank">Bank</button>
				</div>
				</iv>
			</div>
	</nav>
</div>