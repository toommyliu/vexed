<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<style>
	html,
	body {
		height: 100%;
		width: 100%;
		margin: 0;
	}

	#swf {
		position: fixed;
		bottom: 0;
		right: 0;
		width: 100%;
		height: calc(100% - 27px);
	}

	#progress-container {
		position: fixed;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		background-color: black;
		display: flex;
		justify-content: center;
		align-items: center;
	}

	#progress {
		width: 75%;
	}
</style>
<script>
	// https://github.com/electron/electron/issues/254
	window.$ = window.jQuery = require("../shared/jquery.js");
</script>

<script src="jsapi/ItemBase.js"></script>
<script src="jsapi/Faction.js"></script>
<script src="jsapi/Quest.js"></script>
<script src="jsapi/Avatar.js"></script>
<script src="jsapi/Monster.js"></script>

<script src="jsapi/Auth.js"></script>
<script src="jsapi/Bank.js"></script>
<script src="jsapi/Bot.js"></script>
<script src="jsapi/Combat.js"></script>
<script src="jsapi/Drops.js"></script>
<script src="jsapi/Flash.js"></script>
<script src="jsapi/House.js"></script>
<script src="jsapi/Inventory.js"></script>
<script src="jsapi/Packet.js"></script>
<script src="jsapi/Player.js"></script>
<script src="jsapi/Quests.js"></script>
<script src="jsapi/Server.js"></script>
<script src="jsapi/Settings.js"></script>
<script src="jsapi/Shops.js"></script>
<script src="jsapi/TempInventory.js"></script>
<script src="jsapi/World.js"></script>

<script src="ipc/flash-ipc.js"></script>
<script src="ipc/ipc.js"></script>

<script>
	window.addEventListener('DOMContentLoaded', () =>
	{
		var script = document.createElement('script');
		script.textContent = `
			var bot=Bot.getInstance();
			var auth=bot.auth;
			var bank=bot.bank;
			var combat=bot.combat;
			var drops=bot.drops;
			var flash=bot.flash;
			var house=bot.house;
			var inventory=bot.inventory;
			var packets=bot.packets;
			var player=bot.player;
			var quests=bot.quests;
			var settings=bot.settings;
			var shops=bot.shops;
			var tempInventory=bot.tempInventory;
			var world=bot.world;
		`;
		document.body.appendChild(script);
	});
</script>

<script>
	var { ipcRenderer } = require('electron');
	ipcRenderer.on("generate-id", (event, windowID) =>
	{
		console.log(`Your shared ID is: "${windowID}"`);
		window.id = windowID;
	});

	ipcRenderer.on("game:login", function (event, account)
	{
		window.account = account;
	});
</script>

<script>
	var { setIntervalAsync, clearIntervalAsync } = require("set-interval-async/fixed");

	const windows = {};
	let maid = { on: false, player: null, skill_set: null };

	let p_intervalID;
	let p_idx = 0;
	let p_packets = [];

	window.addEventListener('DOMContentLoaded', () =>
	{
		var div = document.createElement('div');
		div.id = 'progress-container';
		document.body.appendChild(div);

		var progress = document.createElement('progress');
		progress.id = 'progress';
		progress.max = "100";
		progress.value = "0";
		document.getElementById('progress-container').appendChild(progress);
	});

	async function progress([percentage])
	{
		var progress = document.getElementById('progress');
		progress.value = percentage.toString();

		if (percentage === 100)
		{
			var progressContainer = document.getElementById('progress-container');
			progress?.remove();
			progressContainer?.remove();

			if (window?.account)
			{
				const { username, password, server } = window.account;
				const bot = Bot.getInstance();
				await bot.sleep(1000);
				await auth.login(username, password);
				if (server !== "None")
				{
					await bot.waitUntil(() => auth?.servers?.length > 0);
					await bot.sleep(250);
					await auth.connect(server);
					await bot.sleep(1000);
				}
				delete window.account;
			}
		}
	}

	$(window).on("message", function (event)
	{
		console.log("Received message", event.originalEvent.data);

		switch (event.originalEvent.data.event)
		{
			case "packets:close": {
				windows.packets = null;
				if (p_intervalID)
				{
					clearIntervalAsync(p_intervalID);
					p_packets = [];
					p_idx = 0;
					p_intervalID = null;
				}
			}
			case "tools:close": {
				windows.tools = null;
				maid.on = false;
			}
				break;
			case "packets:generate_id":
			case "scripts:generate_id":
			case "tools:generate_id": {
				const wnd = event.originalEvent.data.event.split(":")[0]
				windows[wnd] = event.originalEvent.source;
				event.originalEvent.source.postMessage({ event: event.originalEvent.data.event, resp: window.id }, "*");
			}
				break;
			case "packets:save": {
				const { packets } = event.originalEvent.data;
				require("electron").ipcRenderer.send("packets:save", packets);
			}
				break;
			case "packets:spam_start": {
				const { packets, delay } = event.originalEvent.data;

				p_packets = packets;

				if (!p_intervalID)
				{
					p_intervalID = setIntervalAsync(function ()
					{
						Bot.getInstance().packets.sendServer(p_packets[idx++]);
						if (idx >= p_packets.length)
						{
							idx = 0;
						}
					}, delay);
				}
			}
				break;
			case "packets:spam_stop": {
				if (p_intervalID)
				{
					clearIntervalAsync(p_intervalID);
					p_packets = [];
					p_idx = 0;
					p_intervalID = null;
				}
			} break;
			case "tools:maid:start": {
				const { player, skill_set } = event.originalEvent.data;
				maid.on = true;
				maid.player = player;
				maid.skill_set = skill_set;
				break;
			}
			case "tools:maid:stop":
				maid.on = false;
				break;
		}
	});

	$(document).ready(function ()
	{
		const { setIntervalAsync, clearIntervalAsync } = require('set-interval-async/fixed');

		window.lastMap = null;

		setTimeout(function ()
		{
			if (!window.id)
			{
				const { ipcRender } = require("electron");
				ipcRenderer.send("game:generate_id");
				console.log("Looks like we don't have an ID, assigning that now.");
			}
		}, 50);

		$("#scripts").click(function ()
		{
			if (!windows.scripts)
			{
				window.scripts = window.open("./pages/scripts.html", null, "width=451,height=370");
				window.scripts.onload = function ()
				{
					windows.scripts.postMessage("scripts:window-id", window.id, "*");
				}
			}
			else
			{
				windows.scripts.focus();
			}
		});

		$("#tools").click(function ()
		{
			if (!windows.tools)
			{
				windows.tools = window.open("./pages/tools.html", null, "width=451,height=370");
				windows.tools.onload = function ()
				{
					windows.tools.postMessage("tools:window-id", window.id, "*");
				}
			} else
			{
				windows.tools.focus();
			}
		});

		$("#packets").click(function ()
		{
			if (!windows.packets)
			{
				windows.packets = window.open("./pages/packets.html", null, "width=451,height=370");
				windows.packets.onload = function ()
				{
					windows.packets.postMessage("packets:window-id", window.id, "*");
				}
			} else
			{
				windows.packets.focus();
			}
		});

		function updateCells()
		{
			const bot = Bot.getInstance();
			const { auth, player, world } = bot;

			if (!auth.loggedIn || world.loading || window.lastMap === bot.world.roomId)
			{
				return;
			}

			const elem = $("#cells");
			elem.empty();

			const { cells } = world;
			$.each(cells, function (_, option)
			{
				elem.append($('<option>', {
					value: option,
					text: option,
				}));
			});

			window.lastMap = world.roomId;
		}

		$("#pads").on("change", async function ()
		{
			const { auth, world } = Bot.getInstance();
			if (!auth.loggedIn || world.loading)
			{
				return;
			}

			const cell = $("#cells").val() ?? player.cell;
			const pad = $(this).val();

			await Bot.getInstance().world.jump(cell, pad);
		});

		$("#cells").on("click", updateCells)
			.on("change", async function ()
			{
				const { auth, world } = Bot.getInstance();
				if (!auth.loggedIn || world.loading)
				{
					return;
				}

				const cell = $(this).val();
				const pad = $("#pads").val() ?? "Spawn";

				await Bot.getInstance().world.jump(cell, pad);
			});

		$("#x").on("click", async function ()
		{
			const { auth, player, world } = Bot.getInstance();
			if (!auth.loggedIn || world.loading)
			{
				return;
			}

			const cells = $("#cells");
			const pads = $("#pads");

			if (!cells.val())
			{
				updateCells();
			}

			cells.val(player.cell ?? "Enter");
			pads.val(player.pad ?? "Spawn");

			await world.jump(cells.val(), pads.val(), true);
		});

		$("#bank").on("click", function ()
		{
			const bot = Bot.getInstance();
			if (!auth.loggedIn)
			{
				return;
			}

			bot.flash.call("world.toggleBank");
		});

		let skillIdx = 0;
		setIntervalAsync(async function ()
		{
			if (maid.on)
			{
				await bot.waitUntil(() => auth.loggedIn && !world.loading);

				console.log('goto');
				world.goto(maid.player);
				console.log('wait');

				await bot.waitUntil(() => flash.call(window.swf.PlayersInMap)?.includes(maid.player));
				world.setSpawnpoint();

				if (!maid.skill_set.includes(","))
				{
					maid.skill_set = "1,2,3,4";
				}

				const skills = maid.skill_set.split(",")
					.map(s => Number.parseInt(s.trim(), 10))
					.filter(n => !Number.isNaN(n) && n >= 0 && n <= 5);

				console.log('kill');

				if (world.isMonsterAvailable("*"))
				{
					if (!combat.hasTarget())
					{
						combat.attack("*");
					}
					settings.setInfiniteRange();

					console.log(`use skill ${maid.skill_set[skillIdx]}`);
					await combat.useSkill(maid.skill_set[skillIdx]);
					if (++skillIdx >= maid.skill_set.length)
					{
						skillIdx = 0;
					}
				}

				console.log('end');
			}
		}, 1000);
	});
</script>

<div style="position: relative;">
	<embed id="swf" src="grimoire.swf" type="application/x-shockwave-flash"></embed>
</div>

<div class="w3-bar w3-fixed-top" style="background-color: #24242e; color: lightgrey; height: 27px;">
	<a href="#" class="w3-bar-item w3-button w3-small" id="scripts">scripts</a>
	<a href="#" class="w3-bar-item w3-button w3-small" id="tools">tools</a>
	<a href="#" class="w3-bar-item w3-button w3-small" id="packets">packets</a>
	<button class="w3-bar-item w3-button w3-border w3-small w3-right" id="bank"
		style="height: 21px; margin-top: 4px; margin-left: 10px; margin-right: 5px; padding: 0 8px;">bank</button>
	<button class="w3-bar-item w3-button w3-border w3-small w3-right" id="x"
		style="height: 21px; margin-top: 4px; margin-left: 4px; margin-right: -2px; padding: 0 4px;">x</button>
	<select class="w3-bar-item w3-border w3-small w3-right" id="cells" disabled
		style="height: 21px; margin-top: 4px; margin-left: 10px; padding: 0 4px; width: 100px; background-color: #24242e; color: lightgrey"></select>
	<select class="w3-bar-item w3-border w3-small w3-right" id="pads" disabled
		style="height: 21px; margin-top: 4px; margin-right: -4px; padding: 0 10px; width: 100px; background-color: #24242e; color: lightgrey">
		<option value="" selected disabled hidden></option>
		<option value="Center">Center</option>
		<option value="Spawn">Spawn</option>
		<option value="Left">Left</option>
		<option value="Right">Right</option>
		<option value="Top">Top</option>
		<option value="Bottom">Bottom</option>
		<option value="Up">Up</option>
		<option value="Down">Down</option>
	</select>
</div>