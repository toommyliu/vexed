<!doctype html>

<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<script>
	// https://github.com/electron/electron/issues/254
	window.$ = window.jQuery = require("../../shared/jquery.js");
</script>
<style>
	body {
		background-color: #24242e;
		color: lightgrey;
	}

	.logger {
		height: 100px;
		font-size: 11px;
		overflow-y: auto;
		cursor: text;
		white-space: pre-wrap;
		background-color: #24242e;
	}

	.line {
		padding: 5px;
		margin-bottom: 5px;
		cursor: pointer;
		color: lightgrey;
	}

	.line:hover {
		background-color: grey;
	}

	.spammer {
		background-color: #24242e;
		color: lightgrey;
		width: 100%;
	}

	.spammer:focus {
		background-color: #24242e;
		color: lightgrey;
	}
</style>

<body>
	<div class="w3-container mt-4">
		<div class="w3-container">
			<p>logger</p>
			<div class="logger w3-border" id="logger" readonly></div>
			<div style="display: flex; justify-content: space-between; gap: 2px; margin-top: 4px;">
				<div style="display: flex; gap: 4px">
					<button class="w3-btn w3-small w3-border" id="save">save to file</button>
					<button class="w3-btn w3-small w3-border" id="copy">copy all</button>
					<button class="w3-btn w3-small w3-border" id="clear">clear</button>
				</div>
				<div>
					<button class="w3-btn w3-small w3-border" id="l-stop">stop</button>
					<button class="w3-btn w3-small w3-border" id="l-start">start</button>
				</div>
			</div>
		</div>
		<hr />
		<div class="w3-container">
			<p>spammer</p>
			<textarea class="spammer w3-border" id="spammer"></textarea>
			<div style="display: flex; justify-content: space-between; gap: 2px">
				<div style="display: flex; gap: 8px">
					<input class="w3-input w3-small" type="number" value="1000" step="100"
						style="width: 150px; height: 30px; margin-top: 12px;" id="delay"></input>
					<p>delay</p>
				</div>
				<div style="display: flex; align-items: center; gap: 4px">
					<button class="w3-btn w3-small w3-border" id="s-send-once">send once</button>
					<button class="w3-btn w3-small w3-border" id="s-stop">stop</button>
					<button class="w3-btn w3-small w3-border" id="s-start">start</button>
				</div>
			</div>
		</div>
	</div>
</body>

<script>
	const { ipcRenderer: ipc } = require("electron");

	const packets = [];

	let logger_on = false;
	let spammer_on = false;

	let parent = window.opener;

	$(document).ready(function ()
	{
		$(window).on("message", function (event)
		{
			// console.log("Received message", event.originalEvent.data);

			const ev = event.originalEvent;

			switch (ev?.data?.event)
			{
				case "packets:generate_id": {
					window.id = ev.data.resp;
					console.log(`Your shared ID is: "${window.id}"`);
					break;
				}
				case "game:packet_sent": {
					if (!logger_on)
					{
						return;
					}

					const pkt = ev.data.packet.substring(17);

					add_packet(pkt);
					packets.push(pkt);
				}
					break;
			}
		});

		setTimeout(function ()
		{
			if (!window.id)
			{
				console.log("Looks like we don't have an ID, dispatching a request from parent.");
				parent.postMessage({ event: "packets:generate_id" }, "*");
			}
		}, 500);

		$("#save").click(function ()
		{
			parent.postMessage({ event: "packets:save", packets });
		});

		$("#copy").click(async function ()
		{
			await navigator.clipboard.writeText(packets.join("\n"));
		});

		$("#clear").click(function ()
		{
			$("#logger").empty();
			packets.length = 0;
		});

		$("#l-stop").click(function ()
		{
			$("#l-start").attr("disabled", false);
			logger_on = false;
		});

		$("#l-start").click(function ()
		{
			$(this).attr("disabled", true);
			logger_on = true;
		});

		$("#s-send-once").click(function ()
		{
			$("#s-start").click();
			$("#s-stop").click();
		});

		$("#s-stop").click(function ()
		{
			$("#s-start").attr("disabled", false);
			spammer_on = false;

			parent.postMessage({ event: "packets:spam_stop" }, "*");
		});

		$("#s-start").click(function ()
		{
			$(this).attr("disabled", true);
			spammer_on = true;

			const packets = $("#spammer").val();

			if (!packets.length)
			{
				return;
			}

			const pkts = packets.split("\n");
			const delay = Number.parseInt($("#delay").val(), 10);

			parent.postMessage({ event: "packets:spam_start", packets: pkts, delay }, "*");
		});
	});

	function add_packet(packet)
	{
		const elem = $("#logger");
		const div = $("<div>").addClass("line").text(packet);

		div.click(async function ()
		{
			await navigator.clipboard.writeText(packet);
		});

		elem.append(div);
		elem.scrollTop(elem[0].scrollHeight);
	}
</script>