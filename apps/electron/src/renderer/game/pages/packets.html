<!doctype html>
<html data-bs-theme="dark">

<link href="../../shared/bootstrap.css" rel="stylesheet">

<script>
	// https://github.com/electron/electron/issues/254
	window.$ = window.jQuery = require("../../shared/jquery.js");
</script>
<style>
	.logger {
		height: 100px;
		overflow-y: auto;
		cursor: text;
		white-space: pre-wrap;
		background-color: #24242e;
	}

	.line {
		padding: 5px;
		margin-bottom: 5px;
		cursor: pointer;
		color: lightgrey;
	}

	.line:hover {
		background-color: grey;
	}

	.spammer {
		background-color: #24242e;
		color: lightgrey;
		width: 100%;
	}

	.spammer:focus {
		background-color: #24242e;
		color: lightgrey;
	}
</style>

<div class="container mt-4">
	<div class="container">
		<p>logger</p>
		<div class="logger border rounded-1" id="logger" readonly style="height: 150px; overflow-y: auto;"></div>
		<div class="d-flex justify-content-between mt-2">
			<div class="d-flex gap-2">
				<button class="btn btn-sm btn-outline-secondary" id="save" style="color: lightgrey;">save to
					file</button>
				<button class="btn btn-sm btn-outline-secondary" id="copy" style="color: lightgrey;">copy all</button>
				<button class="btn btn-sm btn-outline-secondary" id="clear" style="color: lightgrey;">clear</button>
			</div>
			<div>
				<button class="btn btn-sm btn-outline-secondary" id="l-stop" style="color: lightgrey;">stop</button>
				<button class="btn btn-sm btn-outline-secondary" id="l-start" style="color: lightgrey;">start</button>
			</div>
		</div>
	</div>
	<hr />
	<div class="container">
		<p>spammer</p>
		<textarea class="spammer rounded-1" id="spammer" style="width: 100%; height: 150px;"></textarea>
		<div class="d-flex justify-content-between mt-2">
			<div class="d-flex gap-2">
				<input class="form-control form-control-sm rounded-1" type="number" value="1000" step="100"
					style="width: 150px; height: min-content;" id="delay">
				<p class="mt-1" style="color: lightgrey;">delay</p>
			</div>
			<div class="d-flex align-items-center gap-2">
				<button class="btn btn-sm btn-outline-secondary" id="s-send-once" style="color: lightgrey;">send
					once</button>
				<button class="btn btn-sm btn-outline-secondary" id="s-stop" style="color: lightgrey;">stop</button>
				<button class="btn btn-sm btn-outline-secondary" id="s-start" style="color: lightgrey;">start</button>
			</div>
		</div>
	</div>
</div>

<script>
	const { ipcRenderer: ipc } = require("electron");

	const packets = [];

	let logger_on = false;
	let spammer_on = false;

	const parent = window.opener;

	$(() => {
		$(window).on("message", (event) => {
			// console.log("Received message", event.originalEvent.data);

			const ev = event.originalEvent;

			switch (ev?.data?.event) {
				case "packets:generate_id": {
					window.id = ev.data.resp;
					console.log(`Your shared ID is: "${window.id}"`);
					break;
				}
				case "game:packet_sent": {
					if (!logger_on) {
						return;
					}

					const pkt = ev.data.packet.substring(17);

					add_packet(pkt);
					packets.push(pkt);
				}
					break;
			}
		});

		setTimeout(() => {
			if (!window.id) {
				console.log("Looks like we don't have an ID, dispatching a request from parent.");
				parent.postMessage({ event: "packets:generate_id" }, "*");
			}
		}, 500);

		$("#save").click(() => {
			parent.postMessage({ event: "packets:save", packets });
		});

		$("#copy").click(async () => {
			await navigator.clipboard.writeText(packets.join("\n")).catch(() => { });
		});

		$("#clear").click(() => {
			$("#logger").empty();
			packets.length = 0;
		});

		$("#l-stop").click(() => {
			$("#l-start").attr("disabled", false);
			logger_on = false;
		});

		$("#l-start").click(() => {
			$(this).attr("disabled", true);
			logger_on = true;
		});

		$("#s-send-once").click(() => {
			$("#s-start").click();
			$("#s-stop").click();
		});

		$("#s-stop").click(() => {
			$("#s-start").attr("disabled", false);
			spammer_on = false;

			parent.postMessage({ event: "packets:spam_stop" }, "*");
		});

		$("#s-start").click(function () {
			$(this).attr("disabled", true);
			spammer_on = true;

			const packets = $("#spammer").val();

			if (!packets.length) {
				return;
			}

			const pkts = packets.split("\n");
			const delay = Number.parseInt($("#delay").val(), 10);

			parent.postMessage({ event: "packets:spam_start", packets: pkts, delay }, "*");
		});
	});

	function add_packet(packet) {
		const elem = $("#logger");
		const div = $("<div>").addClass("line").text(packet);

		div.click(async () => {
			await navigator.clipboard.writeText(packet).catch(() => { });
		});

		elem.append(div);
		elem.scrollTop(elem[0].scrollHeight);
	}
</script>

</html>