<link rel="stylesheet" type="text/css" href="../../shared/tree.css">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css" crossorigin="anonymous"
	referrerpolicy="no-referrer">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap-grid.min.css"
	integrity="sha512-i1b/nzkVo97VN5WbEtaPebBG8REvjWeqNclJ6AItj7msdVcaveKrlIIByDpvjk5nwHjXkIqGZscVxOrTb9tsMA=="
	crossorigin="anonymous" referrerpolicy="no-referrer" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap-utilities.min.css"
	integrity="sha512-4ocAKAxnrkSm7MvkkF1D435kko3/HWWvoi/U9+7+ln94B/U01Mggca05Pm3W59BIv3abl0U3MPdygAPLo5aeqg=="
	crossorigin="anonymous" referrerpolicy="no-referrer" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap-reboot.min.css"
	integrity="sha512-HJaQ4y3YcUGCWikWDn8bFeGTy3Z/3IbxFYQ9G3UAWx16PyTL6Nu5P/BDDV9s0WhK3Sq27Wtbk/6IcwGmGSMXYg=="
	crossorigin="anonymous" referrerpolicy="no-referrer" />
<script src="../../shared/tree.js"></script>
<script>
	window.$ = window.jQuery = require("../../shared/jquery.js");
</script>
<style>
	body {
		background-color: #24242e;
		color: lightgrey;
	}

	.grid-container {
		display: grid;
		grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
		grid-gap: 20px;
		padding-top: 8px;
	}

	.grid-item {
		border: 1px solid #ccc;
		padding: 10px;
		text-align: center;
	}

	.tooltip {
		visibility: hidden;
		background-color: #555;
		color: #fff;
		text-align: center;
		padding: 5px 0;
		position: absolute;
		z-index: 1;
		width: auto;
	}

	.grid-item:hover .tooltip {
		visibility: visible;
	}

	#skills {
		margin-bottom: 8px;
	}
</style>

<main>
	<div class="w3-bar w3-black">
		<button class="w3-bar-item w3-button tab-button" data-target="fast-travels">fast travels</button>
		<button class="w3-bar-item w3-button tab-button" data-target="loader-grabber">loader/grabber</button>
		<button class="w3-bar-item w3-button tab-button" data-target="maid">maid</button>
	</div>

	<div class="container-fluid mt-4">
		<div class="tab" id="fast-travels" style="display: none">
			<div class="container-fluid d-flex flex-row justify-content-between gap-4">
				<div class="d-flex">
					<p>room number:</p>
					<input type="number" value="100000" id="room-number"
						style="width: 100px ;height: 20px; margin-left: 4px; margin-top: 4px;">
				</div>
				<button class="w3-button w3-border h-25" id="refresh">refresh</button>
			</div>
			<div class="container-fluid grid-container">
			</div>
		</div>

		<div class="tab" id="loader-grabber">
			<div class="container-fluid">
				<div class="d-flex flex-column gap-2">
					<input type="number" id="loader-id" style="width: 200px;">
					<select class="w3-border w3-small" id="loader-select"
						style="width: 200px; height: 21px; background-color: #24242e; color: lightgrey">
						<option value="" selected disabled hidden></option>
						<option value="0">hair shop</option>
						<option value="1">shop</option>
						<option value="2">quest</option>
						<option value="3">armor customizer</option>
					</select>
					<button class="w3-button w3-border" id="loader-btn" style="width: 200px;">load</button>
				</div>
			</div>
			<div class="container-fluid w3-border mt-4 mb-4" id="grabber-container"
				style="max-width: 400px; margin-left: 12px;">
				<div id="tree" class="dark"></div>
			</div>

			<div class="container-fluid d-grid justify-content-start gap-2 w-25 m-0">
				<select class="w3-border" id="grabber-select"
					style="width: 200px; height: 21px; background-color: #24242e; color: lightgrey; flex: 1;">
					<option value="" selected disabled hidden></option>
					<option value="0">shop items</option>
					<option value="1">quests</option>
					<option value="2">inventory</option>
					<option value="3">temp. inventory</option>
					<option value="4">bank</option>
					<option value="5">monsters</option>
				</select>
				<button class="w3-button w3-border" id="grabber-btn" style="width: 200px;">grab</button>
			</div>
		</div>

		<div class="tab" id="maid" style="display: none">
			<div class="w3-container w3-border container-1">
				<p>goto player</p>
				<input id="player"></input>
				<p>skill set</p>
				<input id="skills" value="1,2,3,4"></input>
			</div>
			<input id="start" type="checkbox">start</input>
		</div>
	</div>
</main>

<script>
	// TODO: support maps that require bypass
	// TODO: add support for room-hopping
	const { ipcRenderer: ipc } = require("electron");

	const fs = require("fs-extra");
	const { join } = require("path");

	const parent = window.opener;

	let rootDir;
	let jsonPath;
	let locations = [];

	let grabberData = [];

	function readJSON()
	{
		return fs.readJSON(jsonPath);
	}
	function writeJSON(json)
	{
		return fs.writeJSON(jsonPath, json, { spaces: 4 });
	}

	(async () =>
	{
		await ipc.invoke("manager:get_path").then(p =>
		{
			rootDir = p;
			jsonPath = join(rootDir, "fast-travels.json");
		});
	})();

	$(async function ()
	{
		await renderFastTravels();

		$(window).on("beforeunload", function (event)
		{
			parent.postMessage({ event: "tools:close" }, "*");
		});

		$(window).on("message", async function (event)
		{
			console.log("Received message", event.originalEvent.data);

			const ev = event.originalEvent;

			switch (ev?.data?.event)
			{
				case "tools:generate_id": {
					window.id = ev.data.resp;
					console.log(`Your shared ID is: "${window.id}"`);
				}
					break;
				case "tools:loader_grabber:grab_shop":
				case "tools:loader_grabber:grab_quests":
				case "tools:loader_grabber:grab_inventory":
				case "tools:loader_grabber:grab_temp_inventory":
				case "tools:loader_grabber:grab_bank":
				case "tools:loader_grabber:grab_monsters": {
					grabberData = ev.data.resp ?? [];
					await renderGrabberTree(ev.data.event.substring("tools:loader_grabber:grab".length + 1));
				}
				// case "tools:loader_grabber:grab_quests":
				// 	questTree = ev.data.resp ?? [];
				// 	await renderQuestTree();
				// 	break;
			}
		});

		setTimeout(function ()
		{
			if (!window.id)
			{
				console.log("Looks like we don't have an ID, dispatching a request from parent.");
				parent.postMessage({ event: "tools:generate_id" }, "*");
			}
		}, 500);

		//#region fast travels
		$("#refresh").click(async function ()
		{
			await renderFastTravels();
		});
		//#endregion

		//#region loader-grabber
		$("#loader-btn").click(function ()
		{
			const id = $("#loader-id").val().trim() || null;
			const slot = Number.parseInt($("#loader-select").val(), 10) ?? null;

			if (!id && slot !== 3)
			{
				return;
			}

			switch (slot)
			{
				case 0:
					parent.postMessage({ event: "tools:loader_grabber:load_hair_shop", resp: id }, "*");
					break;
				case 1:
					parent.postMessage({ event: "tools:loader_grabber:load_shop", resp: id }, "*");
					break;
				case 2:
					parent.postMessage({ event: "tools:loader_grabber:load_quest", resp: id }, "*");
					break;
				case 3:
					parent.postMessage({ event: "tools:loader_grabber:load_armor_customize" }, "*");
					break;
			}
		});

		$("#grabber-btn").click(function ()
		{
			const slot = Number.parseInt($("#grabber-select").val(), 10);

			if (Number.isNaN(slot))
			{
				return;
			}

			switch (slot)
			{
				case 0:
					parent.postMessage({ event: "tools:loader_grabber:grab_shop" }, "*");
					break;
				case 1:
					parent.postMessage({ event: "tools:loader_grabber:grab_quests" }, "*");
					break;
				case 2:
					parent.postMessage({ event: "tools:loader_grabber:grab_inventory" }, "*");
					break;
				case 3:
					parent.postMessage({ event: "tools:loader_grabber:grab_temp_inventory" }, "*");
					break;
				case 4:
					parent.postMessage({ event: "tools:loader_grabber:grab_bank" }, "*");
					break;
				case 5:
					parent.postMessage({ event: "tools:loader_grabber:grab_monsters" }, "*");
					break;
			}
		});
		//#endregion

		$(".tab-button").click(function ()
		{
			$(".tab").hide();

			const target = $(this).data("target");
			$(`#${target}`).show();

			switch (target)
			{
				case "fast-travels":
					break;
				case "loader-grabber":
					break;
				case "maid":
					break;
			}
		});

		$("#start").click(function (event)
		{
			if ($(this).prop("checked"))
			{
				parent.postMessage({
					event: "tools:maid:start",
					player: $("#player").val(),
					skill_set: $("#skills").val()
				}, "*");
			} else
			{
				parent.postMessage({
					event: "tools:maid:stop"
				}, "*");
			}
		});
	});

	async function renderFastTravels()
	{
		await fs.ensureFile(jsonPath);
		await readJSON(jsonPath).then(function (out)
		{
			locations = out;
		}).catch(async function ()
		{
			locations = [
				{ name: "oblivion", map: "tercessuinotlim" },
				{ name: "twins", map: "tercessuinotlim", "cell": "Twins", "pad": "Left" },
				{ name: "vhl/taro/zee", map: "tercessuinotlim", "cell": "Taro", "pad": "Left" },
				{ name: "swindle", map: "tercessuinotlim", "cell": "Swindle", "pad": "Left" },
				{ name: "nulgath/skew", map: "tercessuinotlim", "cell": "Boss2", "pad": "Right" },
				{ name: "polish", map: "tercessuinotlim", "cell": "m12", "pad": "Top" },
				{ name: "carnage/ninja", map: "tercessuinotlim", "cell": "m4", "pad": "Top" },
				{ name: "binky", map: "doomvault", "cell": "r5", "pad": "Left" },
				{ name: "dage", map: "underworld", "cell": "s1", "pad": "Left" },
				{ name: "escherion", map: "escherion", "cell": "Boss", "pad": "Left" },
				{ name: "klunk", map: "underworld", "cell": "r11", "pad": "Left" },
				// { name: "ice spirit", map: "icestormunder", "cell": "Enter", "pad": "Spawn" },
				// { name: "doomvaultb", map: "tercessuinotlim", "cell": "Enter", "pad": "Spawn" },
				// { name: "treetitanbattle", map: "tercessuinotlim", "cell": "Enter", "pad": "Spawn" },
				// { name: "ultradrakath", map: "tercessuinotlim", "cell": "Enter", "pad": "Spawn" },
				// { name: "towerofdoom10", map: "tercessuinotlim", "cell": "Enter", "pad": "Spawn" },
				// { name: "necrodungeon", map: "tercessuinotlim", "cell": "Enter", "pad": "Spawn" },
			];

			await writeJSON(locations);
		});

		const container = $('.grid-container');
		container.empty();

		$.each(locations, function (index, loc)
		{
			if (!loc?.name || !loc?.map)
			{
				return;
			}

			const elem = $('<div class="grid-item w3-button w3-bar">' + loc.name + '<div class="tooltip">' +
				'<p>Map: ' + loc.map + '</p>' +
				'<p>Cell: ' + (loc.cell ?? "Enter") + '</p>' +
				'<p>Pad: ' + (loc.pad ?? "Spawn") + '</p>' +
				'</div></div>');

			elem.click(function ()
			{
				parent.postMessage({
					event: "tools:fast_travel:join",
					data: { ...loc, roomNumber: $("#room-number").val() }
				}, "*");
			});

			container.append(elem);
		});
	}

	async function renderGrabberTree(type)
	{
		$("#tree").empty();

		let json;

		switch (type)
		{
			case "shop":
				json = mapShop();
				break;
			case "quests":
				json = mapQuests();
				break;
			case "inventory":
				json = mapItems(0);
				break;
			case "temp_inventory":
				json = mapItems(1);
				break;
			case "bank":
				json = mapItems(2);
				break;
			case "monsters":
				json = mapMonsters();
				break;
		}

		if (!json)
		{
			return;
		}

		const tree = new Tree(document.getElementById('tree'));
		tree.json(json);

		$('summary').each(function (index, elem)
		{
			$(elem).contextmenu(function ()
			{
				console.log($(this).text());
			});
		});
	}

	function mapShop()
	{
		return grabberData?.["items"]?.map((item) =>
		{
			return {
				name: item.sName,
				type: Tree.FOLDER,
				children: [
					{
						name: `Shop Item ID: ${item.ShopItemID}`
					},
					{
						name: `ID: ${item.ItemID}`
					},
					{
						name: `Cost: ${item.iCost} ${item.bCoins === 1 ? "ACs" : "Gold"}`
					},
					{
						name: `Category: ${item.sType}`
					},
					{
						name: `Description: ${item.sDesc}`
					}
				]
			}
		});
	}

	function mapQuests()
	{
		return grabberData.map((quest) =>
		{
			return {
				name: `${quest.QuestID} - ${quest.sName}`,
				type: Tree.FOLDER,
				children: [
					{ name: `ID: ${quest.QuestID}` },
					{ name: `Description: ${quest.sDesc}` },
					{
						name: "Required Items",
						type: Tree.FOLDER,
						children: Object.values(quest.oItems).map((i) =>
						{
							return {
								name: i.sName,
								type: Tree.FOLDER,
								children: [
									{
										name: `ID: ${i.ItemID}`
									},
									{
										name: `Quantity: ${i.iQty}`
									},
									{
										name: `Temporary: ${i.bTemp ? "Yes" : "No"}`
									},
									{
										name: `Description: ${i.sDesc ?? ""}`
									}
								]
							}
						})
					},
					{
						name: "Rewards",
						type: Tree.FOLDER,
						children: quest.Rewards.map((i) =>
						{
							return {
								name: i.sName,
								type: Tree.FOLDER,
								children: [
									{
										name: `ID: ${i.ItemID}`
									},
									{
										name: `Quantity: ${i.iQty}`
									},
									{
										name: `Drop chance: ${i.DropChance}`
									},
								]
							}
						})
					}
				]
			}
		});
	}

	function mapItems(type)
	{
		if (type === 0 || type === 2)
		{
			return grabberData.map((item) =>
			{
				return {
					name: item.sName,
					type: Tree.FOLDER,
					children: [
						{
							name: `ID: ${item.ItemID}`
						},
						{
							name: `Char Item ID: ${item.CharItemID}`
						},
						{
							name: `Quantity: ${item.iQty}/${item.iStk}`
						},
						{
							name: `AC Tagged: ${item.bCoins === 1 ? "yes" : "no"}`
						},
						{
							name: `Category: ${item.sType}`
						},
						{
							name: `Description: ${item.sDesc}`
						}
					]
				}
			});
		}

		return grabberData.map((item) =>
		{
			return {
				name: item.sName,
				type: Tree.FOLDER,
				children: [
					{
						name: `ID: ${item.ItemID}`
					},
					{
						name: `Quantity: ${item.iQty}/${item.iStk}`
					}
				]
			}
		});
	}

	function mapMonsters()
	{
		return grabberData.map((mon) =>
		{
			return {
				name: mon.strMonName,
				type: Tree.FOLDER,
				children: [
					{
						name: `ID: ${mon.MonID}`
					},
					{
						name: `MonMapID: ${mon.MonMapID}`
					},
					{
						name: `Race: ${mon.sRace}`
					},
					{
						name: `Level: ${mon.iLvl}`
					},
					{
						name: `Health: ${mon.intHP}/${mon.intHPMax}`
					}
				]
			}
		});
	}
</script>