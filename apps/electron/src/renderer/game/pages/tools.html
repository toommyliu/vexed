<link rel="stylesheet" type="text/css" href="../../shared/tree.css">
</link>
<script src="../../shared/tree.js"></script>
<script>
	window.$ = window.jQuery = require("../../shared/jquery.js");
</script>
<style>
	body {
		background-color: #24242e;
		color: lightgrey;
	}

	.room-container {
		display: flex;
		align-items: center;
	}

	.room-container p {
		margin-right: 10px;
	}

	.grid-container {
		display: grid;
		grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
		grid-gap: 20px;
		padding-top: 8px;
	}

	.grid-item {
		border: 1px solid #ccc;
		padding: 10px;
		text-align: center;
	}

	.tooltip {
		visibility: hidden;
		background-color: #555;
		color: #fff;
		text-align: center;
		padding: 5px 0;
		position: absolute;
		z-index: 1;
		width: auto;
	}

	.grid-item:hover .tooltip {
		visibility: visible;
	}

	#skills {
		margin-bottom: 8px;
	}
</style>

<main>
	<div class="w3-bar w3-black">
		<button class="w3-bar-item w3-button tab-button" data-target="fast-travel">fast travel</button>
		<button class="w3-bar-item w3-button tab-button" data-target="loader-grabber">loader/grabber</button>
		<button class="w3-bar-item w3-button tab-button" data-target="maid">maid</button>
	</div>

	<div class="w3-container">
		<div class="tab" id="fast-travel" style="display: none">
			<div class="room-container">
				<p>Room number:</p>
				<input type="number" value=100000 id="room-number">
			</div>
			<button class="w3-button w3-border w3-bar" id="refresh">refresh</button>
			<div class="grid-container">
			</div>
		</div>

		<div class="tab" id="loader-grabber">
			<p>hello from loader/grabber</p>
			<div class="w3-container">
				<button class="w3-button" id="grab-quests">grab quests</button>
				<div class="w3-container">
					<div id="tree" class="dark"></div>
				</div>
			</div>
		</div>

		<div class="tab" id="maid" style="display: none">
			<div class="w3-container w3-border container-1">
				<p>goto player</p>
				<input id="player"></input>
				<p>skill set</p>
				<input id="skills" value="1,2,3,4"></input>
			</div>
			<input id="start" type="checkbox">start</input>
		</div>
	</div>
</main>

<script>
	// TODO: support maps that require bypass
	// TODO: add support for room-hopping
	const { ipcRenderer: ipc } = require("electron");

	const fs = require("fs-extra");
	const { join } = require("path");

	const parent = window.opener;

	let rootDir;
	let jsonPath;
	let locations = [];

	let questTree = [];

	function readJSON()
	{
		return fs.readJSON(jsonPath);
	}
	function writeJSON(json)
	{
		return fs.writeJSON(jsonPath, json, { spaces: 4 });
	}

	(async () =>
	{
		await ipc.invoke("manager:get_path").then(p =>
		{
			rootDir = p;
			jsonPath = join(rootDir, "fast-travels.json");
		});
	})();

	$(async function ()
	{
		// await renderFastTravels();

		$(window).on("beforeunload", function (event)
		{
			parent.postMessage({ event: "tools:close" }, "*");
		});

		$(window).on("message", async function (event)
		{
			console.log("Received message", event.originalEvent.data);

			const ev = event.originalEvent;

			switch (ev?.data?.event)
			{
				case "tools:generate_id": {
					window.id = ev.data.resp;
					console.log(`Your shared ID is: "${window.id}"`);
				}
					break;
				case "tools:loader_grabber:grab_quests":
					questTree = ev.data.resp ?? [];
					await renderQuestTree();
					break;
			}
		});

		setTimeout(function ()
		{
			if (!window.id)
			{
				console.log("Looks like we don't have an ID, dispatching a request from parent.");
				parent.postMessage({ event: "tools:generate_id" }, "*");
			}
		}, 500);

		//#region fast travels
		$("#refresh").click(async function ()
		{
			await renderFastTravels();
		});
		//#endregion

		//#region loader-grabber
		$("#grab-quests").click(function ()
		{
			parent.postMessage({ event: "tools:loader_grabber:grab_quests" });
		});
		//#endregion

		$(".tab-button").click(function ()
		{
			$(".tab").hide();

			const target = $(this).data("target");
			$(`#${target}`).show();

			switch (target)
			{
				case "fast-travel":
					break;
				case "loader-grabber":
					break;
				case "maid":
					break;
			}
		});

		$("#start").click(function (event)
		{
			if ($(this).prop("checked"))
			{
				parent.postMessage({
					event: "tools:maid:start",
					player: $("#player").val(),
					skill_set: $("#skills").val()
				}, "*");
			} else
			{
				parent.postMessage({
					event: "tools:maid:stop"
				}, "*");
			}
		});
	});

	async function renderFastTravels()
	{
		await fs.ensureFile(jsonPath);
		await readJSON(jsonPath).then(function (out)
		{
			locations = out;
		}).catch(async function ()
		{
			locations = [
				{ name: "oblivion", map: "tercessuinotlim" },
				{ name: "twins", map: "tercessuinotlim", "cell": "Twins", "pad": "Left" },
				{ name: "vhl/taro/zee", map: "tercessuinotlim", "cell": "Taro", "pad": "Left" },
				{ name: "swindle", map: "tercessuinotlim", "cell": "Swindle", "pad": "Left" },
				{ name: "nulgath/skew", map: "tercessuinotlim", "cell": "Boss2", "pad": "Right" },
				{ name: "polish", map: "tercessuinotlim", "cell": "m12", "pad": "Top" },
				{ name: "carnage/ninja", map: "tercessuinotlim", "cell": "m4", "pad": "Top" },
				{ name: "binky", map: "doomvault", "cell": "r5", "pad": "Left" },
				{ name: "dage", map: "underworld", "cell": "s1", "pad": "Left" },
				{ name: "escherion", map: "escherion", "cell": "Boss", "pad": "Left" },
				{ name: "klunk", map: "underworld", "cell": "r11", "pad": "Left" },
				// { name: "ice spirit", map: "icestormunder", "cell": "Enter", "pad": "Spawn" },
				// { name: "doomvaultb", map: "tercessuinotlim", "cell": "Enter", "pad": "Spawn" },
				// { name: "treetitanbattle", map: "tercessuinotlim", "cell": "Enter", "pad": "Spawn" },
				// { name: "ultradrakath", map: "tercessuinotlim", "cell": "Enter", "pad": "Spawn" },
				// { name: "towerofdoom10", map: "tercessuinotlim", "cell": "Enter", "pad": "Spawn" },
				// { name: "necrodungeon", map: "tercessuinotlim", "cell": "Enter", "pad": "Spawn" },
			];

			await writeJSON(locations);
		});

		const container = $('.grid-container');
		container.empty();

		$.each(locations, function (index, loc)
		{
			if (!loc?.name || !loc?.map)
			{
				return;
			}

			const elem = $('<div class="grid-item w3-button w3-bar">' + loc.name + '<div class="tooltip">' +
				'<p>Map: ' + loc.map + '</p>' +
				'<p>Cell: ' + (loc.cell ?? "Enter") + '</p>' +
				'<p>Pad: ' + (loc.pad ?? "Spawn") + '</p>' +
				'</div></div>');

			elem.click(function ()
			{
				parent.postMessage({
					event: "tools:fast_travel:join",
					data: { ...loc, roomNumber: $("#room-number").val() }
				}, "*");
			});

			container.append(elem);
		});
	}
	async function renderQuestTree()
	{
		$("#tree").empty();

		var tree = new Tree(document.getElementById('tree'));

		const json = questTree.map((quest) =>
		{
			return {
				name: `${quest.QuestID} - ${quest.sName}`,
				type: Tree.FOLDER,
				children: [
					{ name: `ID: ${quest.QuestID}` },
					{ name: `Description: ${quest.sDesc}` },
					{
						name: "Required Items",
						type: Tree.FOLDER,
						children: Object.values(quest.oItems).map((i) =>
						{
							return {
								name: i.sName,
								type: Tree.FOLDER,
								children: [
									{
										name: `ID: ${i.ItemID}`
									},
									{
										name: `Quantity: ${i.iQty}`
									},
									{
										name: `Temporary: ${i.bTemp ? "Yes" : "No"}`
									},
									{
										name: `Description: ${i.sDesc ?? ""}`
									}
								]
							}
						})
					},
					{
						name: "Rewards",
						type: Tree.FOLDER,
						children: quest.Rewards.map((i) =>
						{
							return {
								name: i.sName,
								type: Tree.FOLDER,
								children: [
									{
										name: `ID: ${i.ItemID}`
									},
									{
										name: `Quantity: ${i.iQty}`
									},
									{
										name: `Drop chance: ${i.DropChance}`
									},
								]
							}
						})
					}
				]
			}
		});

		tree.json(json);

		$('summary').each(function (index, elem)
		{
			$(elem).contextmenu(function ()
			{
				console.log($(this).text());
			});
		});
	}
</script>