<!doctype html>

<link href="../../shared/halfmoon.css" rel="stylesheet">
<script src="../../shared/bootstrap.js"></script>
<script>
	// https://github.com/electron/electron/issues/254
	window.$ = window.jQuery = require("../..//shared/jquery.js");
</script>
<style>
	body {
		background-color: #24242e;
		color: lightgrey;
		font-family: Verdana, Geneva, Tahoma, sans-serif;
	}


	.logger {
		height: 100px;
		font-size: 11px;
		overflow-y: auto;
		cursor: text;
		white-space: pre-wrap;
		background-color: #24242e;
	}

	.line {
		padding: 5px;
		margin-bottom: 5px;
		cursor: pointer;
		color: lightgrey;
	}

	.line:hover {
		background-color: grey;
	}

	.spammer {}
</style>

<body>
	<div class="container mt-4">
		<p>logger</p>
		<div class="form-control logger" id="logger" readonly></div>
		<div class="d-flex justify-content-between mt-2">
			<div class="d-flex gap-2">
				<button class="btn btn-primary btn-sm" id="save">save to file</button>
				<button class="btn btn-primary btn-sm" id="copy">copy all</button>
				<button class="btn btn-primary btn-sm" id="clear">clear</button>
			</div>
			<div class="d-flex align-items-center">
				<input type="checkbox" id="l-enabled"></input>
				<p class="ml-2 mb-0">start</p>
			</div>
		</div>
		<hr />
		<p>spammer</p>
		<textarea class="form-control" id="spammer"></textarea>
		<div class="d-flex justify-content-between mt-2">
			<div class="d-flex gap-2">
				<input type="number" value=1000 step=100 style="width: 150px;" id="delay"></input>
				<p>delay</p>
			</div>
			<div class="d-flex align-items-center">
				<input type="checkbox" id="s-enabled"></input>
				<p class="ml-2 mb-0">start</p>
			</div>
		</div>

	</div>
</body>

<script>
	const { remote, ipcRenderer: ipc } = require("electron");
	const { setIntervalAsync, clearIntervalAsync } = require("set-interval-async/fixed");
	const packets = [];
	let intervalID = null;

	$(document).ready(function ()
	{
		// close existing windows with no parent
		setTimeout(function ()
		{
			if (!window.id)
			{
				window.close();
			}
			else
			{
				console.log(`your parent is ${window.id}`);
			}
		}, 100);

		$("#save").on("click", function ()
		{
			ipc.send("packets:save", packets);
		});

		$("#copy").on("click", async function ()
		{
			await navigator.clipboard.writeText(packets.join("\n"));
		});

		$("#clear").on("click", function ()
		{
			$("#logger").empty();
			packets.length = 0;
		});

		$("#s-enabled").on("click", function()
		{
			if ($(this).prop("checked"))
			{
				const packets = $("#spammer").val();

				if (!packets.length)
				{
					return;
				}

				const pkts = packets.split("\n");
				const delay = Number.parseInt($("#delay").val(), 10);

				if (!intervalID)
				{
					intervalID = setIntervalAsync(function() {
						console.log("starting to send packets to main");
						if (!$("#s-enabled").prop("checked"))
						{
							console.log("Checkbox was unchecked, stopping spam (1)");
							clearIntervalAsync(intervalID);
							intervalID = null;
							return;
						}

						ipc.send("packets:spam", window.id, pkts, delay);
						console.log("sent packets to main");
					}, delay);
				}
			} else
			{
				if (intervalID)
				{
					clearIntervalAsync(intervalID);
					intervalID = null;
					console.log("Spamming stopped as checkbox was unchecked (2)");
				}
			}
		});
	});

	ipc.on("packet", function (_, packet)
	{
		if ($("#l-enabled").prop("checked"))
		{
			add_packet(packet);
			packets.push(packet);
		}
	});

	function add_packet(packet)
	 {
		const elem = $("#logger");
		const div = $("<div>").addClass("line").text(packet);

		div.on("click", async function ()
		{
			await navigator.clipboard.writeText(packet);
		});

		elem.append(div);
		elem.scrollTop(elem[0].scrollHeight);
	}
</script>